---
layout: post
title:  "Day3 creating a simulacrul"
date: 2023-11-08 18:00:00 -0000
author: mpagot
---

<a onclick="window.history.back()">Back</a>

This day is spent in creating a playground to test different setups.

# DONE

Today I played with:

 - KVM and libvirt
 - MicroOS
 - ignition and combustion (mam say "Do not play with fire, but ...")
 - BTRFS cli tools: mkfs.btrfs/mount/btrfs

The general idea is to play with different FS configuration in a virtualized environment. I'm not sure how this one is similar or not in term of performance but at list it is super flexible and hopefully fast.

At some point I also made some decisions about how to proceed. I'd like to give a try to MicroOS as it is immutable and should be relatively minimal.
I'm mostly interested in the immutable part of that: I think it can improve system robustness (rollback).

## Ignition and combustion

Some good reading:
 - HowTo: https://en.opensuse.org/Portal:MicroOS/Ignition#Ignition_Quick_Start
 - How to use ignition with `virt-install` https://balagetech.com/install-opensuse-microos-kvm-ignition/
 - How to use combustion https://pdostal.cz/2022/02/19/installing-opensuse-microos-and-tumbleweed-in-qemu/
 - Create ignition/combustion based qcow image for jumphost https://confluence.suse.com/pages/viewpage.action?pageId=1305018506


### Ignition 'n combusition

They are one alternative to the other. Ignition is a json file and combustion is a bash script. So ignition is maybe a little bit simpler but less flexible. Let's use it to:

 - configure the password for root
 - allow me to ssh to the machine using my ssh key

Before to start I need to do something about the root password. The ignition file needs its hash. It can be created using:

```shell
% openssl passwd -6

Password:
Verifying - Password:
$6$hJ2svTtl37mM/tRL$lWEdUzMOpsqLrJLtTqp2D/WEmZ9O0Jg4gs6RGClnc82c0Ady8iGdjCe1u6TtUFutKlIZc2wB0EB4f9fiRVTOD.
```

A good entry point to create an ignition file is [fuel-ignition](https://opensuse.github.io/fuel-ignition/edit): is is a web base ignition file editor (again thanks Mr Lu).

Here as reference my `config.ign` file

```json
{
  "ignition": {
    "version": "3.2.0"
  },
  "passwd": {
    "users": [
      {
        "name": "root",
        "passwordHash": "**********",
        "sshAuthorizedKeys": [
          "ssh-rsa AA*********\n"
        ]
      }
   ]
  },
  "storage": {
    "filesystems": [
      {
        "device": "/dev/disk/by-label/ROOT",
        "format": "btrfs",
        "mountOptions": [
          "subvol=/@/home"
        ],
        "path": "/home",
        "wipeFilesystem": false
      }
    ]
  },
  "systemd": {
    "units": [
      {
        "name": "sshd.service",
        "enabled": true
      }
    ]
  }
}
```

A small note about the `storage` section: it seems only to be needed due to the MicroOS configuration. There's this note in the `fuel-ignition` webpage

![Image]({{ "/assets/img/assets/img/20231108113906.png" | relative_url }})

This toggle is about adding a section in the ignition json like:

```json
  "storage": {
    "filesystems": [
      {
        "device": "/dev/disk/by-label/ROOT",
        "format": "btrfs",
        "mountOptions": [
          "subvol=/@/home"
        ],
        "path": "/home",
        "wipeFilesystem": false
      }
    ]
  },
```

Not selecting it result in ssh as root not to work even if the deployment looks like ok. Digging in the log of the first boot:

![Image]({{ "/assets/img/assets/img/20231108114019.png" | relative_url }})

How this problem has to be addressed using `combustion`?



## virt-install

First of all I need an image. I have many possibility here:
 - I can try Leap Micro or MicroOS. They are more or less like Leap vs Tumbleweed but for immutable OS. I decided for the rolling release one
 - I can get an ISO and connect it to the VM as a cdrom and perform the installation on an empty qcow2 disk. Or I can directly get the image qcow2 and attach it like a disk to the VM.

### Install from ISO
The ISO is [here](https://download.opensuse.org/tumbleweed/appliances/iso/openSUSE-MicroOS.x86_64-ContainerHost-SelfInstall.iso)


### Install from qcow2


### Ignition and combustion in KVM

#### Provision as disk
Create a small disk image
```
truncate --size=10M ignition_disk.img
```

Create a filesystem in it
```
mkfs.vfat -n ignition ignition_disk.img
```

Mount to fill the disk with the ignition json file
```
mount ignition_disk.img mnt/
mkdir mnt/ignition
cp config.ign mnt/ignition/
umount mnt
```

or for the combustion method:
```
mkdir mnt/combustion
cp script mnt/combustion/
```

At this point `umount` and convert the `.img` disk image to a qcow2
```
qemu-img convert -O qcow2 ./ignition_disk.img ./ignition_disk.qcow2
```

(credit Mr.Lu)

#### Provision as virt-install argument

It is an alternative method and probably a simpler one. This method needs a different syntax:
 - if using `ignition` or `combustion`
 - if booting from .iso or .qcow2

Install from ISO with ignition is done with something like:

```shell
% virt-install ... \
    --boot cdrom --cdrom openSUSE-MicroOS.x86_64-ContainerHost-SelfInstall.iso\
    --sysinfo type=fwcfg,entry0.name="opt/com.coreos/config",entry0.file="/var/lib/libvirt/images/config.ing"
```

Or using the qcow2 and `ignition`

```shell
% virt-install ... \
    --boot hd --disk size=20,backing_store=openSUSE-MicroOS.x86_64-kvm-and-xen.qcow2,bus=virtio,serial=os \
    --qemu-commandline="-fw_cfg name=opt/com.coreos/config,file=/var/lib/libvirt/images/config.ign"
```

Or using the qcow2 and `combustion`

```shell
% virt-install ... \
    --boot hd --disk size=20,backing_store=openSUSE-MicroOS.x86_64-kvm-and-xen.qcow2,bus=virtio,serial=os \
    --qemu-commandline="-fw_cfg name=opt/org.opensuse.combustion/script,file=/var/lib/libvirt/images/script"
```


## Play with BTRFS